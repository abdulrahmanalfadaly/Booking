<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Booking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px 0;
        }

        .back-button {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            margin-right: 15px;
            display: none;
        }

        .back-button.visible {
            display: block;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .subtitle {
            color: #b0b0b0;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .search-box {
            background: #2a2a2a;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 30px;
            padding: 16px 24px;
            width: 100%;
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 30px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-box:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box::placeholder {
            color: #666;
        }

        .facilities-grid {
            display: grid;
            gap: 15px;
        }

        .facility-card {
            background: #2a2a2a;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .facility-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .facility-image {
            width: 140px;
            height: 100px;
            object-fit: cover;
        }

        .facility-info {
            padding: 15px;
            flex: 1;
        }

        .facility-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }


        /* Detail Page Styles */
        .detail-page {
            display: none;
        }

        .detail-page.active {
            display: block;
        }

        .facility-header-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .facility-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .booking-field {
            background: #2a2a2a;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .booking-field:hover {
            background: #333;
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateX(4px);
        }

        .booking-field label {
            color: #b0b0b0;
            font-size: 14px;
            display: block;
            margin-bottom: 5px;
        }

        .booking-field-value {
            color: #ffffff;
            font-size: 16px;
        }

        .field-icon {
            font-size: 24px;
        }


        .confirm-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25);
        }

        .confirm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            border-radius: 16px;
            padding: 24px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
        }

        /* Calendar Styles */
        .calendar {
            width: 100%;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            color: #666;
            font-size: 12px;
            padding: 8px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }

        .calendar-day:hover {
            background: #2a2a2a;
            border-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .calendar-day.disabled {
            color: #444;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .calendar-day.disabled:hover {
            background: #1a1a1a;
            border-color: transparent;
            transform: none;
        }

        /* Time Slot Styles */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .time-slot {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .time-slot:hover {
            background: #2a2a2a;
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .time-slot.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Confirmation Result */
        .result-page {
            display: none;
            text-align: center;
        }

        .result-page.active {
            display: block;
        }

        .result-image-container {
            position: relative;
            margin: 30px 0;
            display: inline-block;
        }

        #resultCanvas {
            max-width: 100%;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        .view-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25);
        }

        .view-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .download-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(17, 153, 142, 0.25);
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(56, 239, 125, 0.4);
        }

        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-overlay img {
            max-width: 95%;
            max-height: 95vh;
            object-fit: contain;
            transform: scale(1.2);
        }

        .success-message {
            color: #38ef7d;
            font-size: 18px;
            margin: 20px 0;
        }

        /* Coordinates Button */
        .coordinates-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            z-index: 100;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .coordinates-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.5);
        }

        /* Coordinates Page */
        .coordinates-page {
            display: none;
        }

        .coordinates-page.active {
            display: block;
        }

        .preview-canvas-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            background: #2a2a2a;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        #previewCanvas {
            width: 100%;
            display: block;
        }

        .coordinates-info {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            color: #b0b0b0;
            font-size: 14px;
            line-height: 1.8;
        }

        .coordinates-info strong {
            color: #ffffff;
        }

        .coordinates-display {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .coord-item {
            color: #b0b0b0;
            font-size: 13px;
        }

        .coord-item strong {
            color: #667eea;
            font-weight: 600;
        }

        #previewCanvas {
            cursor: grab;
        }

        #previewCanvas:active {
            cursor: grabbing;
        }

        .save-coordinates-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(17, 153, 142, 0.25);
        }

        .save-coordinates-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(56, 239, 125, 0.4);
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .facility-image {
                width: 100px;
                height: 80px;
            }

            .facility-name {
                font-size: 16px;
            }

            .time-slots {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Page -->
        <div id="homePage">
            <div class="header">
                <button class="back-button" id="backButton" onclick="goBack()">←</button>
                <h1>Select Facility</h1>
            </div>
            <p class="subtitle">Please select the facilities you are looking for.</p>
            <input type="text" class="search-box" placeholder="Search keywords..." id="searchBox">
            <div class="facilities-grid" id="facilitiesGrid"></div>
        </div>

        <!-- Detail Page -->
        <div id="detailPage" class="detail-page">
            <div class="header">
                <button class="back-button visible" onclick="goToHome()">←</button>
                <h1 id="detailTitle">Facility Details</h1>
            </div>
            <img id="detailHeaderImage" class="facility-header-image" src="" alt="Facility">
            <h2 class="facility-title" id="detailFacilityName"></h2>
            
            <div class="booking-field" onclick="openDatePicker()">
                <div>
                    <label>Date</label>
                    <div class="booking-field-value" id="selectedDate"></div>
                </div>
                <span class="field-icon">›</span>
            </div>

            <div class="booking-field" onclick="openTimePicker()">
                <div>
                    <label>Time</label>
                    <div class="booking-field-value" id="selectedTime"></div>
                </div>
                <span class="field-icon">›</span>
            </div>

            <button class="confirm-button" onclick="confirmBooking()">Confirm Booking</button>
        </div>

        <!-- Result Page -->
        <div id="resultPage" class="result-page">
            <div class="header">
                <button class="back-button visible" onclick="goToHome()">←</button>
                <h1>Booking Confirmed</h1>
            </div>
            <p class="success-message">Your booking has been confirmed</p>
            <div class="result-image-container">
                <canvas id="resultCanvas"></canvas>
            </div>
            <div class="action-buttons">
                <button class="view-button" onclick="viewFullscreen()">View Full Screen</button>
                <button class="download-button" onclick="downloadImage()">Download</button>
            </div>
        </div>

        <!-- Coordinates Configuration Page -->
        <div id="coordinatesPage" class="coordinates-page">
            <div class="header">
                <button class="back-button visible" onclick="goToHome()">←</button>
                <h1>Text Coordinates</h1>
            </div>
            
            <div class="preview-canvas-container">
                <canvas id="previewCanvas"></canvas>
            </div>

            <button class="save-coordinates-button" onclick="saveCoordinates()">Save Coordinates</button>
        </div>
    </div>

    <!-- Coordinates Button (Floating) -->
    <button class="coordinates-button" id="coordinatesBtn" onclick="openCoordinates()" style="display: none;" title="Configure Text Position">⚙</button>

    <!-- Fullscreen Overlay -->
    <div id="fullscreenOverlay" class="fullscreen-overlay" onclick="closeFullscreen()">
        <img id="fullscreenImage" src="" alt="Booking Confirmation">
    </div>

    <!-- Date Picker Modal -->
    <div id="dateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Date</h3>
                <button class="close-modal" onclick="closeDatePicker()">×</button>
            </div>
            <div class="calendar">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="previousMonth()">‹</button>
                    <span id="calendarMonth"></span>
                    <button class="calendar-nav" onclick="nextMonth()">›</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>
    </div>

    <!-- Time Picker Modal -->
    <div id="timeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Time</h3>
                <button class="close-modal" onclick="closeTimePicker()">×</button>
            </div>
            <div class="time-slots" id="timeSlots"></div>
        </div>
    </div>

    <script>
        // Facilities Data - will be loaded from JSON
        let facilitiesData = [];
        let configData = {
            sampleImage: '',
            textCoordinates: {
                dateX: 400,
                dateY: 450,
                timeX: 400,
                timeY: 500
            }
        };

        // State
        let currentFacility = null;
        let selectedDate = new Date();
        let selectedTime = null;
        let currentCalendarDate = new Date();

        // Load facilities from JSON file
        async function loadFacilities() {
            try {
                const response = await fetch('facilities.json');
                if (!response.ok) {
                    throw new Error('Failed to load facilities.json');
                }
                const data = await response.json();
                
                // Extract config and facilities
                configData.sampleImage = data.sampleImage || '';
                configData.textCoordinates = data.textCoordinates || configData.textCoordinates;
                facilitiesData = data.facilities || [];
                
                // Load saved coordinates from localStorage
                const savedCoords = localStorage.getItem('textCoordinates');
                if (savedCoords) {
                    configData.textCoordinates = JSON.parse(savedCoords);
                }
                
                renderFacilities();
                document.getElementById('coordinatesBtn').style.display = 'block';
            } catch (error) {
                console.error('Error loading facilities:', error);
            }
        }

        // Initialize
        async function init() {
            await loadFacilities();
            setDefaultDateTime();
            
            // Search functionality
            document.getElementById('searchBox').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = facilitiesData.filter(facility => 
                    facility.name.toLowerCase().includes(searchTerm)
                );
                renderFacilities(filtered);
            });
        }

        function renderFacilities(facilities = facilitiesData) {
            const grid = document.getElementById('facilitiesGrid');
            grid.innerHTML = facilities.map(facility => `
                <div class="facility-card" onclick="openFacilityDetail(${facility.id})">
                    <img src="${facility.image}" alt="${facility.name}" class="facility-image">
                    <div class="facility-info">
                        <div class="facility-name">${facility.name}</div>
                    </div>
                </div>
            `).join('');
        }

        function openFacilityDetail(facilityId) {
            currentFacility = facilitiesData.find(f => f.id === facilityId);
            document.getElementById('detailFacilityName').textContent = currentFacility.name;
            document.getElementById('detailHeaderImage').src = currentFacility.image;
            
            // Set default time for this facility
            setDefaultTime();
            
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('detailPage').classList.add('active');
            document.getElementById('resultPage').classList.remove('active');
            document.getElementById('coordinatesBtn').style.display = 'none';
        }

        function goToHome() {
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('detailPage').classList.remove('active');
            document.getElementById('resultPage').classList.remove('active');
            document.getElementById('coordinatesPage').classList.remove('active');
            document.getElementById('coordinatesBtn').style.display = 'block';
        }

        // Coordinates Configuration Functions
        let dragState = {
            isDragging: false,
            dragTarget: null, // 'date' or 'time'
            canvasImage: null,
            canvasRect: null
        };

        function openCoordinates() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('coordinatesPage').classList.add('active');
            document.getElementById('coordinatesBtn').style.display = 'none';
            
            // Load image and setup drag
            loadPreviewImage();
        }

        function loadPreviewImage() {
            const img = new Image();
            img.onload = function() {
                dragState.canvasImage = img;
                setupCanvasDrag();
                updatePreview();
            };
            img.src = configData.sampleImage;
        }

        function setupCanvasDrag() {
            const canvas = document.getElementById('previewCanvas');
            
            // Remove old listeners
            canvas.onmousedown = null;
            canvas.onmousemove = null;
            canvas.onmouseup = null;
            canvas.ontouchstart = null;
            canvas.ontouchmove = null;
            canvas.ontouchend = null;
            
            // Mouse events
            canvas.addEventListener('mousedown', handleDragStart);
            canvas.addEventListener('mousemove', handleDragMove);
            canvas.addEventListener('mouseup', handleDragEnd);
            canvas.addEventListener('mouseleave', handleDragEnd);
            
            // Touch events
            canvas.addEventListener('touchstart', handleDragStart);
            canvas.addEventListener('touchmove', handleDragMove);
            canvas.addEventListener('touchend', handleDragEnd);
        }

        function getCanvasCoordinates(e) {
            const canvas = document.getElementById('previewCanvas');
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function isNearText(mouseX, mouseY, textX, textY, threshold = 30) {
            const dx = mouseX - textX;
            const dy = mouseY - textY;
            return Math.sqrt(dx * dx + dy * dy) < threshold;
        }

        function handleDragStart(e) {
            e.preventDefault();
            const coords = configData.textCoordinates;
            const pos = getCanvasCoordinates(e);
            
            // Check if clicking near date or time text
            if (isNearText(pos.x, pos.y, coords.dateX, coords.dateY)) {
                dragState.isDragging = true;
                dragState.dragTarget = 'date';
            } else if (isNearText(pos.x, pos.y, coords.timeX, coords.timeY)) {
                dragState.isDragging = true;
                dragState.dragTarget = 'time';
            }
        }

        function handleDragMove(e) {
            if (!dragState.isDragging) return;
            e.preventDefault();
            
            const pos = getCanvasCoordinates(e);
            
            if (dragState.dragTarget === 'date') {
                configData.textCoordinates.dateX = Math.round(pos.x);
                configData.textCoordinates.dateY = Math.round(pos.y);
            } else if (dragState.dragTarget === 'time') {
                configData.textCoordinates.timeX = Math.round(pos.x);
                configData.textCoordinates.timeY = Math.round(pos.y);
            }
            
            updatePreview();
        }

        function handleDragEnd(e) {
            dragState.isDragging = false;
            dragState.dragTarget = null;
        }

        function updatePreview() {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            const coords = configData.textCoordinates;

            if (!dragState.canvasImage) return;

            // Use image's natural dimensions - DO NOT CHANGE
            canvas.width = dragState.canvasImage.naturalWidth;
            canvas.height = dragState.canvasImage.naturalHeight;

            // Draw sample image at original size
            ctx.drawImage(dragState.canvasImage, 0, 0);

            // Draw sample text with Inter Medium
            ctx.fillStyle = '#dcd7d6';
            ctx.font = '500 20px Inter, Arial, sans-serif';
            ctx.textAlign = 'left';
            
            // Draw date
            const dateText = 'Monday, 02 Dec 2024';
            ctx.fillText(dateText, coords.dateX, coords.dateY);
            
            // Draw time
            const timeText = '7:00 PM - 9:00 PM';
            ctx.fillText(timeText, coords.timeX, coords.timeY);

            // Draw crosshairs and drag handles
            ctx.strokeStyle = '#ff00ff';
            ctx.lineWidth = 2;
            
            // Date crosshair
            ctx.beginPath();
            ctx.arc(coords.dateX, coords.dateY, 20, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(coords.dateX - 10, coords.dateY);
            ctx.lineTo(coords.dateX + 10, coords.dateY);
            ctx.moveTo(coords.dateX, coords.dateY - 10);
            ctx.lineTo(coords.dateX, coords.dateY + 10);
            ctx.stroke();
            
            // Time crosshair
            ctx.beginPath();
            ctx.arc(coords.timeX, coords.timeY, 20, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(coords.timeX - 10, coords.timeY);
            ctx.lineTo(coords.timeX + 10, coords.timeY);
            ctx.moveTo(coords.timeX, coords.timeY - 10);
            ctx.lineTo(coords.timeX, coords.timeY + 10);
            ctx.stroke();

            // Update coordinate displays
            document.getElementById('dateXValue').textContent = coords.dateX;
            document.getElementById('dateYValue').textContent = coords.dateY;
            document.getElementById('timeXValue').textContent = coords.timeX;
            document.getElementById('timeYValue').textContent = coords.timeY;
        }

        function saveCoordinates() {
            const coords = configData.textCoordinates;
            localStorage.setItem('textCoordinates', JSON.stringify(coords));
            
            goToHome();
        }

        function setDefaultDateTime() {
            // Set default date
            const today = new Date();
            selectedDate = today;
            updateDateDisplay();

            // Time will be set when facility is selected
            selectedTime = null;
            updateTimeDisplay();
        }

        function setDefaultTime() {
            // Set default time based on current facility's time slots
            if (!currentFacility || !currentFacility.timeSlots || currentFacility.timeSlots.length === 0) return;
            
            const today = new Date();
            const currentHour = today.getHours();
            let defaultSlotIndex = Math.floor((currentHour - 7) / 2);
            if (defaultSlotIndex < 0) defaultSlotIndex = 0;
            if (defaultSlotIndex >= currentFacility.timeSlots.length) defaultSlotIndex = currentFacility.timeSlots.length - 1;
            
            selectedTime = currentFacility.timeSlots[defaultSlotIndex];
            updateTimeDisplay();
        }

        function updateDateDisplay() {
            // Format as "Monday, 02 Dec 2024"
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dayName = days[selectedDate.getDay()];
            const day = String(selectedDate.getDate()).padStart(2, '0');
            const month = months[selectedDate.getMonth()];
            const year = selectedDate.getFullYear();
            document.getElementById('selectedDate').textContent = `${dayName}, ${day} ${month} ${year}`;
        }

        function updateTimeDisplay() {
            document.getElementById('selectedTime').textContent = selectedTime || 'Select time';
        }

        // Date Picker
        function openDatePicker() {
            currentCalendarDate = new Date(selectedDate);
            renderCalendar();
            document.getElementById('dateModal').classList.add('active');
        }

        function closeDatePicker() {
            document.getElementById('dateModal').classList.remove('active');
        }

        function renderCalendar() {
            const monthYear = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('calendarMonth').textContent = monthYear;

            const grid = document.getElementById('calendarGrid');
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => 
                `<div class="calendar-day-header">${day}</div>`
            ).join('');

            // Empty cells before first day
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day disabled"></div>';
            }

            // Days of month
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                const isSelected = selectedDate.getDate() === day && 
                                  selectedDate.getMonth() === currentCalendarDate.getMonth() &&
                                  selectedDate.getFullYear() === currentCalendarDate.getFullYear();
                const isPast = currentDate < today;
                
                html += `<div class="calendar-day ${isSelected ? 'selected' : ''} ${isPast ? 'disabled' : ''}" 
                         onclick="${isPast ? '' : `selectDate(${day})`}">${day}</div>`;
            }

            grid.innerHTML = html;
        }

        function selectDate(day) {
            selectedDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
            updateDateDisplay();
            closeDatePicker();
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        // Time Picker
        function openTimePicker() {
            renderTimeSlots();
            document.getElementById('timeModal').classList.add('active');
        }

        function closeTimePicker() {
            document.getElementById('timeModal').classList.remove('active');
        }

        function renderTimeSlots() {
            if (!currentFacility || !currentFacility.timeSlots) return;
            
            const container = document.getElementById('timeSlots');
            container.innerHTML = currentFacility.timeSlots.map(slot => `
                <div class="time-slot ${selectedTime === slot ? 'selected' : ''}" 
                     onclick="selectTime('${slot}')">
                    ${slot}
                </div>
            `).join('');
        }

        function selectTime(slot) {
            selectedTime = slot;
            updateTimeDisplay();
            closeTimePicker();
        }

        // Confirm Booking
        function confirmBooking() {
            if (!selectedTime) {
                return;
            }

            generateBookingImage();
            document.getElementById('detailPage').classList.remove('active');
            document.getElementById('resultPage').classList.add('active');
            
            // Automatically show fullscreen after a brief delay to let canvas render
            setTimeout(() => {
                viewFullscreen();
            }, 100);
        }

        function generateBookingImage() {
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.onload = function() {
                // Use image's natural dimensions - DO NOT CHANGE
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;

                // Draw template image at original size
                ctx.drawImage(img, 0, 0);

                // Get saved coordinates
                const coords = configData.textCoordinates;

                // Add text with Inter Medium
                ctx.fillStyle = '#dcd7d6';
                ctx.font = '500 20px Inter, Arial, sans-serif';
                ctx.textAlign = 'left';
                
                // Format date as "Monday, 02 Dec 2024"
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const dayName = days[selectedDate.getDay()];
                const day = String(selectedDate.getDate()).padStart(2, '0');
                const month = months[selectedDate.getMonth()];
                const year = selectedDate.getFullYear();
                const dateStr = `${dayName}, ${day} ${month} ${year}`;
                ctx.fillText(dateStr, coords.dateX, coords.dateY);
                
                // Draw time at configured position
                ctx.fillText(selectedTime, coords.timeX, coords.timeY);
            };
            img.src = currentFacility.templateImage;
        }

        function downloadImage() {
            const canvas = document.getElementById('resultCanvas');
            const link = document.createElement('a');
            link.download = `booking-${currentFacility.name.replace(/\s+/g, '-')}-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function viewFullscreen() {
            const canvas = document.getElementById('resultCanvas');
            const img = document.getElementById('fullscreenImage');
            img.src = canvas.toDataURL('image/png');
            document.getElementById('fullscreenOverlay').classList.add('active');
        }

        function closeFullscreen() {
            document.getElementById('fullscreenOverlay').classList.remove('active');
        }

        // Initialize app
        init();
    </script>
</body>
</html>

